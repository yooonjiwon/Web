package com.seoul.dao;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.List;

import com.seoul.dto.ContactsBoard;

public class ContactsBoardDao {
	
	public int insertBoard(ContactsBoard board) {
		Connection conn = null;
		PreparedStatement pstmt = null;	//for insert
		PreparedStatement pstmt2 = null;//for select
		ResultSet rs = null;
		int newBoardNo = -1;
		try {
//			//1. Driver 등록
//			Class.forName("oracle.jdbc.OracleDriver");
//			//2. 연결 만들기
//			conn = DriverManager.getConnection(
//					"jdbc:oracle:thin:@210.16.214.202:1521:xe", //연결대상 
//					"seoul", "789123");//계정정보
			conn = ConnectionHelper.getConnection("oracle");
			//3. SQL 작성 및 명령 만들기
			String sql = "INSERT INTO w_board (board_no, board_title, writer_id, board_content, groupno, step) " +
						 "VALUES (contactsboard_seq.nextval, ?, ?, ?, contactsboard_seq.currval, 1)";
			pstmt = conn.prepareStatement(sql);
			pstmt.setString(1, board.getTitle());
			pstmt.setString(2, board.getWriter());
			pstmt.setString(3, board.getContent());
			//4. 명령 실행
			pstmt.executeUpdate();//insert, update, delete 구문 실행 메서드
			
			//위에서 insert된 글의 글번호 조회
			//-> 마지막으로 호출된 nextval의 값을 조회
			sql = "SELECT contactsboard_seq.currval FROM DUAL";
			pstmt2 = conn.prepareStatement(sql);
			rs = pstmt2.executeQuery();
			rs.next();
			newBoardNo = rs.getInt(1);
		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			//6. 연결 종료
			try { rs.close(); } catch (Exception ex) {}
			try { pstmt.close(); } catch (Exception ex) {}
			try { pstmt2.close(); } catch (Exception ex) {}
			try { conn.close(); } catch (Exception ex) {}
		}
		
		return newBoardNo;
	}
	
	public List<ContactsBoard> selectBoard() {
		Connection conn = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		//조회된 데이터를 저장할 DTO 변수 (여러 건이므로 컬렉션 형식)
		ArrayList<ContactsBoard> boards = new ArrayList<>();
		
		try {
//			//1. Driver 등록
//			Class.forName("oracle.jdbc.OracleDriver");
//			//2. 연결 만들기
//			conn = DriverManager.getConnection(
//					"jdbc:oracle:thin:@localhost:1521:xe", //연결대상 
//					"demoweb", "oracle");//계정정보
			conn = ConnectionHelper.getConnection("oracle");
			
			//3. SQL 작성 및 명령 만들기
			String sql = "SELECT board_no, board_title, writer_id, posted_time, read_counter, board_status, groupno, step, reply_depth" + 
						 "FROM w_board " +
						 "ORDER BY groupno DESC, step ASC ";
			pstmt = conn.prepareStatement(sql);
			//4. 명령 실행
			rs = pstmt.executeQuery();//select 구문 실행 메서드
			//5. 결과가 있을 경우 처리
			while (rs.next()) { //조회된 데이터가 있다면 
				ContactsBoard board = new ContactsBoard();
				board.setBoardNo(rs.getInt(1));
				board.setTitle(rs.getString(2));
				board.setWriter(rs.getString(3));
				board.setRegDate(rs.getDate(4));
				board.setReadCount(rs.getInt(5));
				board.setDeleted(rs.getBoolean(6));
				board.setGroupNo(rs.getInt(7));
				board.setStep(rs.getInt(8));
				board.setDepth(rs.getInt(9));
				boards.add(board);//각 게시글 데이터를 목록에 추가
			}
		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			//6. 연결 종료
			try { rs.close(); } catch (Exception ex) {}
			try { pstmt.close(); } catch (Exception ex) {}
			try { conn.close(); } catch (Exception ex) {}
		}
		
		return boards;//조회 성공하면 목록 아니면 count가 0
	}
	
	public List<ContactsBoard> selectBoardList2(int first, int last) {
		
		Connection conn = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		ArrayList<ContactsBoard> boards = new ArrayList<ContactsBoard>();
		
		try {
//			//1. Driver 등록
//			Class.forName("oracle.jdbc.OracleDriver");
//			//2. 연결 만들기
//			conn = DriverManager.getConnection(
//					"jdbc:oracle:thin:@localhost:1521:xe", //연결대상 
//					"demoweb", "oracle");//계정정보
			conn = ConnectionHelper.getConnection("oracle");
			
			StringBuffer sql = new StringBuffer(500);
			sql.append("SELECT * ");
			sql.append("FROM ");
			
			sql.append("( ");
			sql.append("	SELECT "); 
			sql.append("		rownum idx, s.* "); 
			sql.append("	FROM ");
			
			sql.append("	( ");
			sql.append("		SELECT "); 
			sql.append("			board_no, board_title, writer_id, ");
			sql.append("			posted_time, read_counter, ");
			sql.append("			board_status, groupno, step, reply_depth ");
			sql.append("		FROM ");
			sql.append("			w_board ");
//			sql.append("		WHERE ");
//			sql.append("			deleted = '0' ");
			sql.append("		ORDER BY groupno DESC, step ASC ");
			sql.append("	) s ");
			
			sql.append(") ");
			
			sql.append("WHERE idx >= ? AND idx < ?");
			
			pstmt = conn.prepareStatement(sql.toString());
			pstmt.setInt(1, first);
			pstmt.setInt(2, last);
			rs = pstmt.executeQuery();			
			
			while (rs.next()) {
				ContactsBoard board = new ContactsBoard();
				board.setBoardNo(rs.getInt(2));
				board.setTitle(rs.getString(3));
				board.setWriter(rs.getString(4));
				board.setRegDate(rs.getDate(5));
				board.setReadCount(rs.getInt(6));
				board.setDeleted(rs.getBoolean(7));
				board.setGroupNo(rs.getInt(8));
				board.setStep(rs.getInt(9));
				board.setDepth(rs.getInt(10));
				
				boards.add(board);
			}
		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			if (pstmt != null) try { pstmt.close(); } catch (Exception ex) {}
			if (conn != null) try { conn.close(); } catch (Exception ex) {}
		}
		
		return boards;
	}
	
	public int getBoardCount() {
		Connection conn = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		int count = 0;
		try {
//			Class.forName("oracle.jdbc.OracleDriver");
//			conn = DriverManager.getConnection(
//					"jdbc:oracle:thin:@localhost:1521:xe", //연결대상 
//					"demoweb", "oracle");//계정정보
			conn = ConnectionHelper.getConnection("oracle");
			
			String sql = "SELECT COUNT(*) FROM w_board";
			pstmt = conn.prepareStatement(sql);
			rs = pstmt.executeQuery();
			if (rs.next())
				count = rs.getInt(1);
			
		} catch (Exception ex) {
			count = 0;
			ex.printStackTrace();			
		} finally {
			try { if (rs != null) rs.close(); } catch (Exception ex) { }
			try { if (pstmt != null) pstmt.close(); } catch (Exception ex) { }
			try { if (conn != null) conn.close(); } catch (Exception ex) { }
		}
		return count;
	}

}
